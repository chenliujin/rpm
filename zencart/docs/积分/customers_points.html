<h1>1 Table</h1>

<h2>1.1 积分类型</h2>
<ul>
	<li>
		<p><strong>customers_points.type=11</strong></p>
		<p>评论积分，立即生效。</p>
		<p>评论、回复、图片、视频获到的积分。</p>
	</li>
	<li>
		<p><strong>customers_points.type=17</strong></p>
		<p>购买积分（bought point），60天生效，来源数据 orders</p>
		<p>大客户订单部分退款。购买积分。使用积分。促销积分。订单退款（购买积分。活动积分</p>
	</li>
	<li>
		<strong>customers_points.type=19</strong>
		<p>affiliate point，<strong>可以兑换现金</strong>，60天生效，来源数据 orders。</p>
	</li>
	<li>
		<strong>customers_points.type=20</strong>
		<p>退款积分</p>
	</li>
	<li>
		<strong>customers_points.type=55</strong>
		<p>extended affiliate 活动积分，<strong>可以兑换现金</strong>，立即生效。</p>
	</li>
	<li>
		<strong>customers_points.type=66</strong>
		<p>activity point，活动积分，立即生效</p>
		<p>用户激活EBAY帐号送积分，注册账户送积分（自动的） 或者手动给的积分</p>
		<p>原来的 type 是 20</p>
	</li>
</ul>

<h2>1.2 积分状态</h2>
<ul>
	<li>
		<p><strong>customers_points.point_status = 0</strong></p>
		<p>60天生效</p>
	</li>
	<li>
		<p><strong>customers_points.point_status = 1</strong></p>
		<p>立即生效</p>
	</li>
	<li>
		<p><strong>customers_points.point_status = 2</strong></p>
		<p>积分无效</p>
	</li>
	<li>
		<p><strong>customers_points.point_status = 3</strong></p>
		<p>积分使用 | 积分冻结，相应的 point 为负数</p>
	</li>
	<li>
		<p><strong>customers_points.point_status = 4</strong></p>
		<p>订单发生警告积分冻结，相应的积分记为负数？</p>
	</li>	
</ul>

<h2>1.3 过期时间</h2>
<ul>
	<li>customers_points.expiry_time = 0：没有时间限制的积分</li>
	<li>customers_points.expiry_time > 0 && customers_points.expiry_time > now：有时间限制但未过期的积分</li>
</ul>

<h1>2 积分状态变化</h1>
<table class="wiki">
<tbody><tr><td> <strong>从</strong> </td><td> <strong>到</strong> </td><td> <strong>条件</strong> </td><td> <strong>平台</strong> </td><td> <strong>说明</strong> 
</td></tr><tr><td> 0 </td><td> 2 </td><td> 全额退款 </td><td> OMS </td><td> 用户下单得到的购买积分,当在发生全额退款时，会直接将该笔积分置为无效状态。<strong>（还包括提警告前未发货）</strong> 
</td></tr><tr><td> 0 </td><td> 4 </td><td> 警告 </td><td> 网站 </td><td> 用户下单得到的购买积分,当在发生全额退款时，会直接将该笔积分置为无效状态。<strong>（还包括提警告前未发货）</strong> 
</td></tr><tr><td> 1 </td><td> 2 </td><td> 全额退款 </td><td> OMS </td><td> 用户下单使用的积分   ，当用户发生全额退款时，将该笔积分置为无效。<strong>（还包括提警告前未发货）</strong> 
</td></tr><tr><td> 1 </td><td> 4 </td><td> 警告 </td><td> 网站 </td><td> 用户使用的积分，当用户提交警告时<strong>（已发货）</strong>，会将该笔积分冻结。但是在发生下笔订单时，该笔积分也不能够继续使用。直到仲裁结束。吧 
</td></tr><tr><td> 3 </td><td> 0 </td><td> 收款 </td><td> 服务 &amp;网站 </td><td> 用户使用的积分   在收到款项后会将该笔积分置为立即生效 
</td></tr><tr><td> 3 </td><td> 1 </td><td> 收款 </td><td> 服务 &amp;网站 </td><td> 用户使用的积分   在收到款项后会将该笔积分置为立即生效 
</td></tr><tr><td> 3 </td><td> 2 </td><td> 未收款 cancel订单 </td><td> 服务 </td><td> 用户未付款   直接将状态置为无效   或者用户Cancel订单 
</td></tr><tr><td> 4 </td><td> 0 </td><td> 警告 </td><td> 网站 </td><td> 用户提交警告时候下单得到的购买积分会冻结。等待仲裁结束。如果胜诉则该笔积分生效赠送到客户账户。 
</td></tr><tr><td> 4 </td><td> 1 </td><td> 警告 </td><td> 网站 </td><td> <strong>(point&lt;0)</strong>用户提交警告时候下单使用的积分会冻结，等待仲裁结束。如果发货，无论输赢   该笔积分都会扣除生效 
</td></tr><tr><td> 4 </td><td> 2 </td><td> 警告 </td><td> 网站 </td><td> <strong>(points&gt;0)</strong>用户提交警告时候下单得到的购买积分会冻结。等待仲裁结束。如果败诉则该笔积分无效 
</td></tr></tbody></table>


<h1>3 配置项</h1>
<p>发放积分时需要加上过期时间</p>
<ul>
	<li>POINTS_FOR_BOUGHT_EXPRIY_DAYS</li>
	<li>POINTS_FOR_REVIEW_EXPRIY_DAYS</li>
	<li>POINTS_FOR_AFFILIATE_EXPRIY_DAYS</li>
</ul>

<h1>4 获得积分</h1>
<h2>4.1 购买积分计算</h2>
<ul>
	<li>实际产品支付金额（除去运费），每100美元获得10积分：round($total_usd_price/100*10, 2)</li>
	<li>西联支付方式积分 x 2</li>
</ul>


<h2>4.2 paypalwpp 购买积分</h2>
<ul>
	<li>在新购物车页面，用户点击 paypalwapp 按钮进行支付</li>
	<li>生成订单，orders.orders_status=0，POST 数据到 paypal，用户确认后返回</li>
	<li>返回订单确认页，用户 Continue</li>
	<li>开始支付 Pending: orders.orders_status = 1</li>
	<li>
		<p>派送积分</p>
		<ul>
			<li>
				<p>购买积分</p>
				<p>customers_points.type = 17</p>
				<p>customers_points.point_status = 3</p>
			</li>
			<li>
				<p>折扣码积分：I类折扣码?</p>
				<p>customers_points.type = 17</p>
				<p>customers_points.point_status = 3</p>				
			</li>
		</ul>
	</li>
</ul>

<h2>4.2 订单</h2>
<h3>4.2.1 下单</h3>



<h3>4.2.2 支付成功</h3>






<h1>5 积分使用</h1>

<h2>5.1 可用积分（有效积分）</h2>
<h2>5.2 积分使用记录（log）</h2>

<h1>6 UML</h1>
<h2>Customer</h2>
<ul>
	<li>
		<p><strong>Customer::updateCustomerPointStatus</strong></p>
		<p>ModelCustomer::updateCustomerPointStatus</p>
		<p>ok</p>
	</li>
	<li>
		<p><strong>Customer::resetCustomerOrderPoint($customers_id, $orders_id)</strong></p>
	</li>	
</ul>


<h2>ModelCustomer</h2>
<ul>
	<li>
		<p><strong><s>countCustomerPointsTotal</s></strong></p>
		<p>未使用，计算订单产生了的几条 point 相关记录</p>
		<p>参数</p>
		<ul>
			<li>customer_id</li>
			<li>orders_id</li>
		</ul>
	</li>
	<li>
		<p><strong>getCustomerPointInfoByGroup</strong></p>
		<p>获取用户可用的积分，按类型返回</p>
		<p>参数</p>
		<ul>
			<li>customer_id</li>
			<li>type=null，默认返回所有 type</li>
		</ul>
	</li>
	<li>
		<p><strong>getCustomerUsablePointsValue</strong></p>
		<p>获取用户不可以使用的积分</p>
		<p>参数</p>
		<ul>
			<li>customer_id</li>
			<li>type=null</li>
		</ul>
	</li>
	<li>
		<p><strong>getCustomerTotalPointsValue</strong></p>
		<p>获取用户总的积分</p>
	</li>
	<li>
		<p><strong>genCustomerPointTrack</strong></p>
		<p>增加一条记录，积分消费时</p>
	</li>
	<li>
		<p><strong>delCustomerPoint</strong></p>
		<p>删除积分</p>
	</li>	
	<li>
		<p><strong>updateCustomerPoint</strong></p>
		<p>修改积分</p>
	</li>	
	<li>
		<p><strong>addCustomerPoint</strong></p>
		<p>获得积分</p>
	</li>	
	<li>
		<p><strong>updateCustomerPointStatus</strong></p>
		<p>订单取消时，将订单相关的积分设置为无效</p>
	</li>	
</ul>

<h1>7 参考文献</h1>
<ul>
	<li>ticket#5570</li>
</ul>

